@page "/admin/blogs/editor/{Slug?}"

@inject HttpClient _httpClient
@inject IStringLocalizer<Resource> _localizer
@inject NavigationManager _navigation
@inject IToaster _toaster
@inject ToasterService _toasterService
@inject IMapper _mapper

<PageTitleComponent Title="@_localizer["new-post"]" />

<PostEditorComponent @ref="_postEditorComponent"
                     Post="@Post"
                     OnSaveCallback="OnSaveAsync"
                     OnRemoveCallback="OnRemoveAsync"
                     OnFileUploadCallback="OnFileUploadAsync">
</PostEditorComponent>

@code {

  [Parameter] public string? Slug { get; set; }

  private PostEditorComponent _postEditorComponent = default!;

  protected PostEditorDto Post { get; set; } = new PostEditorDto
    {
      Title = string.Empty,
      Description = string.Empty,
      Content = string.Empty,
      PostType = PostType.Post,
      Cover = BlogifierSharedConstant.DefaultCover,
      Categories = new List<CategoryDto>(),
    };


  protected override async Task OnParametersSetAsync()
  {
    if (!string.IsNullOrEmpty(Slug))
    {
      Post = (await _httpClient.GetFromJsonAsync<PostEditorDto>($"api/post/byslug/{Slug}"))!;
      if (Post.Categories == null) Post.Categories = new List<CategoryDto>();
      await _postEditorComponent.SetPostInfoAsync(Post);
    }
  }

  protected async Task OnSaveAsync(FrontPostEditorDto input)
  {
    var post = _mapper.Map<PostEditorDto>(input);

    if (post.Id == 0)
    {
      var response = await _httpClient.PostAsJsonAsync<PostEditorDto>($"api/post/add", post);
      if (_toasterService.CheckResponse(response))
      {
        var slug = await response.Content.ReadAsStringAsync();
        _navigation.NavigateTo($"/admin/blogs/editor/{slug}");
      }
    }
    else
    {
      var response = await _httpClient.PutAsJsonAsync<PostEditorDto>($"api/post/update", post);
      _toasterService.CheckResponse(response);
    }
  }

  protected async Task OnRemoveAsync(int id)
  {
    var result = await _httpClient.DeleteAsync($"api/post/{id}");
    if (result.IsSuccessStatusCode) _toaster.Success(_localizer["completed"]);
    else _toaster.Error(_localizer["generic-error"]);
    _navigation.NavigateTo($"admin");
  }

  //protected async Task OnFileUploadAsync(FrontFilePreviewDto file)
  //{
  //  using var fileContent = new StreamContent(file.BrowserFile.OpenReadStream());
  //  fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.BrowserFile.ContentType);
  //  using var content = new MultipartFormDataContent();
  //  content.Add(content: fileContent, name: "\"file\"", fileName: file.BrowserFile.Name);
  //  var response = await _httpClient.PostAsync("api/storage/upload", content);
  //  if (response.IsSuccessStatusCode)
  //  {
  //    var stream = await response.Content.ReadAsStreamAsync();
  //    var storage = JsonSerializer.Deserialize<StorageDto>(stream, BlogifierSharedConstant.DefaultJsonSerializerOptions)!;
  //    await _postEditorComponent.ReplaceSelectionAsync(file, storage);
  //  }
  //}

}
